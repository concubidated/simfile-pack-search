<!DOCTYPE html>
<html>
<head>
	<title>Pack - {{ pack.name }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jcanvas/21.0.1/jcanvas.js"></script>
    {% load static %}


<style>
.collapsing {
  transition: none !important;
}
.render {
      width: 276px;
      height: 300px;
      position: relative;
      border: 1px solid #ccc;
      overflow: hidden;
    }

/* The scrollable area */
.scrollbar-notes {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow-y: scroll;
      z-index: 1;
}

/* Fake scroll height filler */
.fake-scroll {
      width: 1px;
      height: 5000px; /* Large enough for all virtual rows */
}

/* Fixed canvas on top */
.canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 2;
      pointer-events: none; /* Let scroll events pass through */
}

</style>

</head>
<body class="container my-4 bg-dark text-light">
    <h1 class="text-center">{{ song.title }}</h1>
    <h3 class="text-center">{{ song.artist }}</h3>
    <div class="row mb-4">
        <div class="col-md-4 text-center">
            {% if song.banner %}
                <img class="img-fluid rounded" src="/media/images/songs/{{ song.banner }}" alt="{{ song.title }}">
            {% endif %}
            <ul class="list-group mt-3">
		    <li class="list-group-item bg-dark text-light"><strong>Pack:</strong><a href="/pack/{{ pack.id}}"> {{ pack.name }}</a></li>
		{% if song.subtitle %}
                <li class="list-group-item bg-dark text-light"><strong>Subtitle:</strong> {{ song.subtitle }}</li>
		{% endif %}
                <li class="list-group-item bg-dark text-light"><strong>Length:</strong> {{ song.song_length_formatted }}</li>
		<li class="list-group-item bg-dark text-light"><strong>BPM:</strong> {{ song.bpms }}</li>
            </ul>
        </div>
        <div class="col-md-8">
	    <div id="render" class="render">
	        <div id="scrollbar-notes" class="scrollbar-notes">
		    <div id="fake-scroll" class="fake-scroll"></div>
		</div>
		<canvas id="notefield" width="320"></canvas>
            </div>
	    <div class="col-4">
		<label for="zoom-slider">Zoom: </label>
		<input type="range" id="zoom-slider" min="1" max="16" value="8" step=".1">
			<span id="zoom-value">8</span>
	    </div>
            <div id="filterCheckboxes">
            </div>
            <label>
                {% if translit %}
                <input type="checkbox" id="toggleLanguage"> Show Translated Data
                {% endif %}
            </label>
        </div>
    </div>

    <div class="container mt-4 mb-4">
        <!-- Top-level Tabs (Games) -->
        <ul class="nav nav-tabs" id="gameTabs" role="tablist">
          {% for game in chart_types %}
          <li class="nav-item" role="presentation">
            <button class="nav-link bg-dark text-light {% if forloop.first %}active{% endif %}" id="{{ game }}-tab" data-bs-toggle="tab" data-bs-target="#{{ game }}" type="button" role="tab">{{ game }}</button>
          </li>
          {% endfor %}
        </ul>
        <div class="tab-content pt-3" id="gameTabsContent">
          {% for game, styles in chart_types.items %}
          <!-- TAB PANE -->
          <div class="tab-pane fade show {% if forloop.first %}active{% endif %}" id="{{ game }}" role="tabpanel">
            <!-- Styles -->
            <ul class="nav nav-tabs mb-3" id="{{ game }}StyleTabs" role="tablist">
            {% for style in styles %}
              <li class="nav-item" role="presentation">
                <button class="nav-link bg-dark text-light {% if forloop.first %}active{% endif %}" id="{{ game }}-{{ style }}-tab" data-bs-toggle="tab" data-bs-target="#{{ game }}-{{ style }}" type="button" role="tab">{{ style }}</button>
              </li>
            {% endfor %}
            </ul>
            {% for style, charts in styles.items %}
            <div class="tab-content" id="{{ game }}StyleContent">
              <div class="tab-pane fade show {% if forloop.first %}active{% else %}{% endif %}" id="{{ game }}-{{ style }}" data-toggle="buttons" role="tabpanel" aria-labelledby="{{ game }}-single-tab">
                <!-- Chart buttons -->
                {% for id, chart in charts.items %} 
                <input
                    type="radio"
		    class="btn-check {% if chart.difficulty == 'Easy' %}Success
				{% elif chart.difficulty == 'Medium' %}Warning
				{% elif chart.difficulty == 'Hard' %}Danger
				{% elif chart.difficulty == 'Challenge'%}Primary
				{% elif chart.difficulty == 'Edit'%}Secondary
				{% else %}{% endif %}"
                    name="btnradio"
		    id="button-{{ chart.id }}"
                    autocomplete="off"
                    onclick="hideOthers('{{ chart.id }}')"
		{% if forloop.first %}{% if forloop.parentloop.first %}{% if forloop.parentloop.parentloop.first %}checked{% endif %}{% endif %}{% endif %}>
                <label class="btn btn-outline-{% if chart.difficulty == 'Easy' %}success
				{% elif chart.difficulty == 'Medium' %}warning
				{% elif chart.difficulty == 'Hard' %}danger
				{% elif chart.difficulty == 'Challenge'%}primary
				{% elif chart.difficulty == 'Edit'%}secondary
				{% else %}info{% endif %}" for="button-{{ chart.id }}">{{ chart.difficulty }} {{ chart.meter }}</label>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
          </div>
          {% endfor %}
        </div>
      </div>

<div id="chart-details">
    {% for chart in charts %}
        <div 
            id="collapse-{{ chart.id }}"
	        class="collapse {% if forloop.first %}show{% endif %} mb-2"
        >
            <div class="container bg-dark">
                <div class="row">
                    <div class="col-8">
			<span>Peak Notes/Second: {{ chart.npspeak|floatformat:2}}</span>
                        <canvas class="mb-4" id="chart-{{ chart.id }}" style="display: block; box-sizing: border-box; height: 200px; width: 500px;"></canvas>

			<table class="mb-4 table table-sm table-borderless table-dark">
			<tr>
				<td>Chart Key</td>
				<td>{{ chart.chartkey}}</td>
			</tr>
			</table>

			<hr>
			{% if chart.common_packs.count > 1 %}
			<span>Other Packs</span>
			<table class="table table-sm table-dark">
                            {% for common_pack in chart.common_packs %}
			    <tr>
                            {% if common_pack.id != pack.id %}
			    <tr>
                                <td>{{ common_pack.name }}</td>
			        <td><a href="/pack/{{ common_pack.id }}">Download</a></td> 
				</tr>
                            {% endif %}
                            {% endfor %}

			</table>
			{% else %}
			<span>Not found on any other packs</span>
			{% endif %}
		    </div>
		    <div class="col-4">
			<span>Chart Author: {{ chart.author }}</span>
			<table class="table table-sm table-dark">
			{% for key, value in chart.taps.items %}
			<tr>
				<td class="text-capitalize"><strong>{{ key }}</strong></td>
				<td>{{ value }}</td>
			</tr>
			{% endfor %}
			</table>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<script>

{% for chart in charts %}
	{% if chart.chartdata %}
        var chart_{{ chart.id }} = {
            notes: {{ chart.chartdata.data|safe }}, 
	    charttype: "{{ chart.charttype }}",
	    width: {{ chart.notefield_width }}
        };

        // You can log the chart to check
	{% endif %}
{% endfor %}
</script>

<script src="/static/js/chartviewtest.js"></script>


<script>

let chartData = null;
let canvas = $('#render canvas');
let chartId = null;

function hideOthers(currentId) {
    chartId = currentId;
    const allCollapses = document.querySelectorAll('#chart-details .collapse');
    const currentCollapse = document.getElementById(`collapse-${currentId}`);
    const currentInstance = bootstrap.Collapse.getOrCreateInstance(currentCollapse, { toggle: false });

    // If the current one is already shown, don't collapse it
    const isAlreadyVisible = currentCollapse.classList.contains('show');

    // Hide all others
    allCollapses.forEach(collapseEl => {
        const id = collapseEl.id.split('collapse-')[1];
        const instance = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
        if (id !== currentId) {
            instance.hide();
        }
    });

    // Only show it if it wasn't already visible
    if (!isAlreadyVisible) {
        currentInstance.show();
    }

    // Render chart on open
    const chartVarName = `chart_${currentId}`;
    chartData = window[chartVarName];
    if (chartData) {
	canvas[0].width = chartData.width;
	canvas.css('width', chartData.width + 'px');
	$('#render').width(chartData.width+20);
	drawNoteField(chartData, zoom);
        //render(canvas, chartData.notes, 10);
    }
}
</script>

<script>
function drawNoteField(chart, zoom) {

	const size = 64;
        // recalulate scroll length
        var length = ((chart.notes.length * size * zoom) + size)
	$(`#fake-scroll`).height(length)

	var scrollTop = $(`#scrollbar-notes`).scrollTop();

        const startMeasure = Math.floor(scrollTop / (size * zoom));
        const endMeasure = Math.min(startMeasure + 24, chart.notes.length - 1);

        let visibleNotes = chart.notes.slice(startMeasure, endMeasure + 1);
        if (visibleNotes.length === 0 && startMeasure < chart.notes.length) {
        	visibleNotes = [chart.notes[startMeasure]];
        }

        // pixel offset
        const pixelOffset = scrollTop % (size * zoom);

        render(canvas, visibleNotes, zoom, chart.charttype);

        canvas.css({
        	'transform': `translateY(-${pixelOffset}px)`,
                'transform-origin': 'top-left'
        });
}

// Update on scroll
$(`.scrollbar-notes`).on('scroll', function() {
	drawNoteField(chartData, zoom)

});

// Set up zoom slider
$('#zoom-slider').on('input', function() {
	// Get the current zoom level
	zoom = $(this).val();
	var zoomSpanId = $('#zoom-value');  // Use the correct selector for your chart
	zoomSpanId.text(zoom);
		drawNoteField(chartData, zoom);
	});

</script>

<script>
$( document ).ready(function() {
    {% for chart in charts %}
        const ctx{{ chart.id }} = document.getElementById('chart-{{ chart.id }}');
        createChart(ctx{{ chart.id }}, {{ chart.npsgraph }});
    {% endfor %}

    canvas = $('#render canvas')
    {% with charts|first as initial_chart %}
	chartId = {{ initial_chart.id }}
	chartData = chart_{{ initial_chart.id }}
    	drawNoteField(chartData, zoom);
    {% endwith %}

});

function createChart(ctx, data) {
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map((_, index) => index),
            datasets: [{
                data: data,
                borderColor: 'blue',
                borderWidth: 0,
		backgroundColor: 'grey',
                fill: true,
                tension: 0.4 // Interpolation mode for smooth curves
            }]
        },
        options: {
            elements: {
                    point: {
                            radius: 0,
                    }
            },
            responsive: false,
            maintainAspectRatio: false,
            scales: {
                x: {
                    display: false // Hides x-axis since labels aren't needed
                },
                y: {
                    display: true, // Hides y-axis for simplicity
                    //suggestedMax: 15,
                }
            },
            plugins: {
                legend: {
                    display: false // No legend for a minimal look
                }
            }
        }
    });
}
</script>
