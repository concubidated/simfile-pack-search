<!DOCTYPE html>
<html>
<head>
    <title>Song List</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    {% load static %}
    {% load humanize %}

</head>
<body class="container my-4">

	<h1 class="text-center mb-4"><strike>Stepmania</strike> Outfox Packs</h1>
    <div class="table-responsive">

    <div id="filterCheckboxes">
        <label><input type="checkbox" class="filter-checkbox" value="dance"> Dance</label>
        <label><input type="checkbox" class="filter-checkbox" value="pump"> Pump</label>
	<label><input type="checkbox" class="filter-checkbox" value="smx"> SMX</label>
	<label><input type="checkbox" class="filter-checkbox" value="techno"> Techno</label>
        <label><input type="checkbox" class="filter-checkbox" value="bm"> Beatmania</label>
        <label><input type="checkbox" class="filter-checkbox" value="iidx"> IIDX</label>
    </div>
    <table id="packTable" class="table table-striped table-hover table-bordered">
        <thead class="table-dark">
            <tr>
		<th class="no-sort"></th>
                <th>Pack</th>
                <th>Size</th>
		<td>Song Count</th>
		<td>Types(s)</td>
		<td>Credit(s)</td>
		<td>Date</td>
		<td class="no-sort">Download</td>
            </tr>
        </thead>
        <tbody>
        {% for pack in packs %}
		<tr>
			<td><img class="img-fluid rounded" style="max-height:100px;" src="/media/images/packs/{% if pack.banner %}{{ pack.banner }}{% else %}nobanner.png{% endif %}"></td>
		<td class="small"><a href="/pack/{{ pack.id }}">{{ pack.name|slice:":64" }}{% if pack.name|length > 64 %}...{% endif %}</a></td>
		<td data-sort="{{ pack.size }}" class="small">{{ pack.size|filesizeformat }}</td>
		<td class="small">{{ pack.song_count }}</td>
		<td data-sort="{{ pack.types }}" width="100px" class="small">
			{% for type in pack.types %}
			<img alt="{{ type }}" class="img-fluid d-inline-block" style="max-width: 30px; filter: invert(1);" src="{% static 'images/types/'|add:type|add:'.png' %}">
			{% endfor %}
		</td>
		<td class="small">{% if pack.authors|length > 4 %}Various{% else %}{% for author in pack.authors %}{{ author }}<br>{% endfor %}{% endif %}</td>
		<td class="small">{{ pack.date_scanned|date:"Y-m-d" }}</td>
		<td class="text-center"><a href="/downloads/packs/{{ pack.name }}.zip"><strong class="bi bi-download"></strong></a></td>
		</tr>
	{% empty %}
		<tr>
		<td colspan="4" class="text-center">No songs available.</td>
		</tr>
	{% endfor %}

        </tbody>
    </table>

</body>
</html>

<script>
    $(document).ready(function() {
        $('#packTable').DataTable({
            paging: true,
            searching: true,
            ordering: true,
	    columnDefs: [{
                orderable: false,
                targets: "no-sort"
            }],
            pageLength: 25,
            lengthMenu: [25, 50, 100, 200], // Options for rows per page
            language: {
                search: "ðŸ” Search Packs:", // Custom search placeholder
                lengthMenu: "Show _MENU_ songs per page",
                info: "Showing _START_ to _END_ of _TOTAL_ songs",
                infoEmpty: "No songs found",
                paginate: {
                    previous: "â† Previous",
                    next: "Next â†’"
                }
            }
        });
    });

$(document).ready(function () {
    var table = $('#packTable').DataTable();

    // Track active filters
    let activeFilters = [];

    // Custom filter logic for JSON data-sort field
    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
        var jsonData = $(table.row(dataIndex).node()).find('td:eq(4)').data('sort');

        try {
            var packTypes = JSON.parse(jsonData.replace(/'/g, '"')); // Convert to valid JSON format
        } catch (e) {
            console.error('Invalid JSON data-sort:', jsonData);
            return false; // Skip if JSON parsing fails
        }

        // Show all rows if no filters are active
        if (activeFilters.length === 0) {
            return true;
        }

        // Check for any active filter match
        return activeFilters.some(filter => packTypes.includes(filter));
    });

    // Checkbox change logic
    $('#filterCheckboxes .filter-checkbox').on('change', function () {
        const filterValue = $(this).val();

        if (this.checked) {
            activeFilters.push(filterValue);
        } else {
            activeFilters = activeFilters.filter(f => f !== filterValue); // Remove if unchecked
        }

        table.draw(); // Redraw the table with updated filters
    });
});
</script>

